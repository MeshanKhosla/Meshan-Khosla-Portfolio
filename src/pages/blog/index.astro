---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import GridCard from '../../components/GridCard.astro';
import SearchBox from '../../components/SearchBox.astro';

// Get all blog posts sorted by date
const allPosts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Format date helper
const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
};

// Prepare posts for search (used by search component's data attribute)
const searchPosts = allPosts.map((post) => ({
  slug: post.slug,
  title: post.data.title,
  description: post.data.description,
  pubDate: post.data.pubDate.toISOString(),
}));
---

<Layout title="Blog" description="Technical blog posts about distributed systems, software engineering, and more.">
  <div class="p-6 lg:p-12">
    <!-- Header -->
    <header class="max-w-4xl mb-10">
      <h1 class="font-serif text-3xl lg:text-4xl font-semibold mb-4">Blog</h1>
      <p class="text-charcoal-muted dark:text-sand-muted text-balance">
        Thoughts on distributed systems, software engineering, and things I'm learning.
      </p>
    </header>

    <!-- Search / Filter -->
    <div class="max-w-md mb-10">
      <SearchBox posts={searchPosts} />
    </div>

    <!-- Posts Grid - All posts rendered, filtered by search -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {allPosts.map((post) => (
        <GridCard
          title={post.data.title}
          description={post.data.description}
          url={`/blog/${post.slug}`}
          image={post.data.heroImage}
          meta={formatDate(post.data.pubDate)}
          slug={post.slug}
        />
      ))}
    </div>
  </div>
</Layout>
